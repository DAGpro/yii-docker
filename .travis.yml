language: bash
services: docker

env:
  - DOCKERFILE_FLAVOUR=debian PHP_BASE_IMAGE_VERSION=5.6-fpm
  - DOCKERFILE_FLAVOUR=debian PHP_BASE_IMAGE_VERSION=7.0-fpm
  - DOCKERFILE_FLAVOUR=debian PHP_BASE_IMAGE_VERSION=7.1-fpm
  - DOCKERFILE_FLAVOUR=debian PHP_BASE_IMAGE_VERSION=7.2-fpm
  - DOCKERFILE_FLAVOUR=debian PHP_BASE_IMAGE_VERSION=7.3-fpm
  - DOCKERFILE_FLAVOUR=debian PHP_BASE_IMAGE_VERSION=7.4-fpm
  - DOCKERFILE_FLAVOUR=debian PHP_BASE_IMAGE_VERSION=5.6-apache
  - DOCKERFILE_FLAVOUR=debian PHP_BASE_IMAGE_VERSION=7.0-apache
  - DOCKERFILE_FLAVOUR=debian PHP_BASE_IMAGE_VERSION=7.1-apache
  - DOCKERFILE_FLAVOUR=debian PHP_BASE_IMAGE_VERSION=7.2-apache
  - DOCKERFILE_FLAVOUR=debian PHP_BASE_IMAGE_VERSION=7.3-apache
  - DOCKERFILE_FLAVOUR=debian PHP_BASE_IMAGE_VERSION=7.4-apache

matrix:
  allow_failures:
    # Deprecated PHP versions
    - env: DOCKERFILE_FLAVOUR=debian PHP_BASE_IMAGE_VERSION=5.6-fpm
    - env: DOCKERFILE_FLAVOUR=debian PHP_BASE_IMAGE_VERSION=7.0-fpm
    - env: DOCKERFILE_FLAVOUR=debian PHP_BASE_IMAGE_VERSION=5.6-apache
    - env: DOCKERFILE_FLAVOUR=debian PHP_BASE_IMAGE_VERSION=7.0-apache

before_install:
  - export TEST_YII_VERSION=7f8bb969fc9737b9af656fc4452d98ac5f34ab53
  - export DOCKER_COMPOSE_VERSION=1.16.1
  - export PHP_IMAGE_NAME=yiisoftware/yii-php
  - if [ -n "$TRAVIS_TAG" ]; then export PHP_IMAGE_VERSION_SUFFIX=-${TRAVIS_TAG}; fi
  - sudo apt-get update
  - sudo apt-get install docker-ce
  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin

install:
  - git clone https://github.com/yiisoft/yii-core _host-volumes/yii-core
  - pushd _host-volumes/yii-core && git checkout ${TEST_YII_VERSION} && popd
  - cp .env-dist .env

before_script:
  - pwd
  - docker version
  - docker info
  - docker-compose version

script:
  - echo "travis_fold:start:BUILD folding starts"
  - docker-compose build
  - echo "travis_fold:end:BUILD folding ends"
  - docker-compose run --rm php php -v
  - docker-compose run --rm php npm -v
  - docker-compose run --rm php php /tests/requirements.php
  - docker-compose run --rm -w /yii-core php composer install
  - docker-compose run --rm -w /yii-core php php -d error_reporting="E_ALL ^ E_DEPRECATED" vendor/bin/phpunit tests/framework/ --exclude db

after_script:
  - docker images

after_success:
  - if [[ $TRAVIS_BRANCH = "master" || -n "$TRAVIS_TAG" ]]; then
      echo $DOCKERHUB_PASS | docker login -u $DOCKERHUB_USER --password-stdin  &&
      docker-compose push;
    fi

# vim:set et ts=2 sw=2:

notifications:
  slack:
    -
      rooms:
        -
          secure: ggC2bdFoMf9PJwlqHNMZSaYYgCRmCkSLoZRzQ3lB5i0pdr2n9ISjPxRLSbmDsWPjRYv1uSlQo4i3Yn9QAIqzl7nJJceXY3nQ02kwqj4zIxjL/dBdNPZLenO2n4+Sv4k18QkmfDS1wTBU2rJYIyxFp8rpm0e5H9leqa6Am5YnJbqQ9y2Tl+TwlJLMOVCm3Nj9F5xXCFDsDIGR/qkX+rvqbtMPruSZKWyM2jeengo11zFEmsBUrqI9pDStYjjLM5UWk0V65yj/f4mC/GRq/KAgHoGy/1U9QpGcxKGS3lsjJog5iUnT9DWVbKUzumFVhbg9D0gCqOvhtJWbkPmWDLaK5N29aUyLa5tkGsmCpaQpg//M0l5/uuNuoXQb/MoBLucJ/+Jga58SsC99BoiQ+meODOcMw7K60N6IrSFQr1m0y195ZlnW59KphjL5cdiBR9NJNm8wgYVrtzZbUptK1q0bp7dPWGrE+SXJiKuuG6sL+31F+kebfPpuhaJ3KWd3lBNJQ+cgbD/rtElFORd+9uZnA0kF3zc9GwHg2wbrRdq0xJDt0CGZjzjXLt1AYQbA2FsAX3sJJjmuxgVUTaUHFAgykFyLSz0oLI4a+1QBcE1ORFvqHI5fHsJ97lnPSaQkl8A+0bRFrYJeLjqF0ndpyVeeBgmOm/NHtadLSVmjCdgWEMA=
      on_success: always
      on_failure: never
      on_pull_requests: false
    -
      rooms:
        -
          secure: hsF63ox567frvLDstBjaoWsqFl5hfKEleTm3X8O30WDLz+bKY3Tq5NvwzpbOp9y5tttITNA8y7p+N8J1OkoDr/fUtMmnyehugROXjr1P1zIyOUpSSMz/8pDYIS2LGbEWSFTEIM0+rWaTxeKqDF1F5L6XA4YDRbP0ThFvErfo3oewCEwXRkkdojqhP7mBljVZlO5u3lTGl028NfSVOhAnLaLSJxdN08m8f8hSGxsB53PqXrOG2Ku08IdzcstMqPas9P0aDggy8qX8s7RxZXBXk2odhV0+9VTBjGAtA3CrPGl15KuXBwMc7lrjFhlWOsR9h1rq394eUQBKfnMYXqgmxqSlcTuKkVVFpjuAdcdoRO6/OBNBj+sZMC32rXlEn9r4wZMX/mdIdDcYtJAeRlF2YjtFA/77lCU9aIlLqY1x60F6AInOvxOxqnghkE4InyRdg2ukgl8kLmQnGSMhOeA8d38b6C60k3GTYq01+gQMT9zduXMYALD/NRWlUX2wTnlCxawXENjgTONpzJ8gQp2zo5Wv2A3dqJL7IK12qu4EhM/XO2GTCofzA7Xk/HTrrF1APpaD/1A1tbUt0sjjOzqWcaFGCFbHtVMG6ekZGZCNgqou34GDa2RiM3MUwtNj6PboFpPR4PpQ3pSlPEzDQyQKwQpXpnqaVeZeliMjwzCLOls=
      on_success: never
      on_failure: always
      on_pull_requests: false
